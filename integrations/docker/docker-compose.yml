version: "3.8"

services:

  events-generator:
    image: events-generator
    build:
      dockerfile_inline: |
        FROM ubuntu:20.04
        RUN apt update && apt install -y python3-requests
    container_name: events-generator
    volumes:
      - ../tools/events-generator:/home/events-generator
    hostname: events-generator
    working_dir: "/home/events-generator"
    entrypoint: sh -c "python3 run.py"
    networks:
      wazuh-indexer-dev:
        aliases:
          - events-generator
        ipv4_address: 172.18.0.2
    depends_on:
      - wazuh-indexer
  
  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.8.0-beta1
    container_name: wazuh-indexer
    hostname: wazuh-indexer
    restart: always
    networks:
      wazuh-indexer-dev:
        aliases:
          - wazuh-indexer
        ipv4_address: 172.18.0.3
    ports:
      - "9222:9200"
    depends_on:
      - generator
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "bootstrap.memory_lock=true"
      - 'INDEXER_PASSWORD=SecretPassword'
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ./wazuh-indexer-data:/var/lib/wazuh-indexer
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/certs/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh1.indexer-key.pem:/usr/share/wazuh-indexer/certs/wazuh1.indexer.key
      - ./config/wazuh_indexer_ssl_certs/wazuh1.indexer.pem:/usr/share/wazuh-indexer/certs/wazuh1.indexer.pem
      - ./config/wazuh_indexer_ssl_certs/admin.pem:/usr/share/wazuh-indexer/certs/admin.pem
      - ./config/wazuh_indexer_ssl_certs/admin-key.pem:/usr/share/wazuh-indexer/certs/admin-key.pem
      - ./config/wazuh_indexer/wazuh1.indexer.yml:/usr/share/wazuh-indexer/opensearch.yml
      - ./config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/opensearch-security/internal_users.yml

  generator:
    image: wazuh/wazuh-certs-generator:0.0.1
    hostname: wazuh-certs-generator
    volumes:
      - ./config/wazuh_indexer_ssl_certs/:/certificates/
      - ./config/certs.yml:/config/certs.yml
    environment:
      - HTTP_PROXY=YOUR_PROXY_ADDRESS_OR_DNS
  
  logstash:
    image: logstash
    build:
      dockerfile_inline: |
        FROM ubuntu:20.04
        RUN apt update && apt install -y iputils-ping wget gpg apt-transport-https
        WORKDIR /home/logstash
        RUN wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | gpg --dearmor -o /usr/share/keyrings/elastic-keyring.gpg && \
            echo "deb [signed-by=/usr/share/keyrings/elastic-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | tee -a /etc/apt/sources.list.d/elastic-8.x.list && \
            apt update && \
            apt install -y logstash && \
            chown -R logstash:logstash /etc/logstash && \
            chown logstash:logstash /home/logstash
    entrypoint: /usr/share/bin/logstash --path.settings /etc/logstash --config.reload.automatic
    container_name: logstash
    hostname: logstash
    user: logstash
    volumes:
      - ../amazon-security-lake:/home/logstash
      - ../amazon-security-lake/logstash/pipe-output.conf:/etc/logstash/conf.d/pipe-output.conf
      - ../amazon-security-lake/logstash/pipelines.yml:/etc/logstash/pipelines.yml
    networks:
      wazuh-indexer-dev:
        aliases:
          - logstash
        ipv4_address: 172.18.0.4
    depends_on:
      - wazuh-indexer
      - s3-ninja
  
  s3-ninja:
    image: scireum/s3-ninja
    container_name: s3-ninja
    hostname: s3-ninja
    volumes:
      - ./s3-ninja_data:/home/sirius/data
    networks:
      wazuh-indexer-dev:
        aliases:
          - s3-ninja
        ipv4_address: 172.18.0.5
    ports:
      - "9444:9000"

networks:
  wazuh-indexer-dev:
    ipam:
      config:
        - subnet: "172.18.0.0/16"
